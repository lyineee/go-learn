package main

import (
	"context"
	"testing"

	"github.com/lyineee/go-learn/utils"
	"github.com/stretchr/testify/assert"
)

func TestTiebaExtractor(t *testing.T) {
	ast := assert.New(t)
	text := `var commonPageData = PageData || {};    var PageData = {        page: 'pb', product: 'pb',        tbs: 'c85b89a9e04682ab1643331826',        can_post:1, can_anonym_post:0, forum_type: 1, follow_sign: "fc4f01d23b28c963", forward_sign: "7bb74cc1ffcda87a", power: {"can_add_celebrity":false,"can_add_manager_team":false,"can_bws_FDS":false,"can_bws_bawu_center":false,"can_bws_bawu_info":false,"can_bws_bawu_log":false,"can_bws_filter_ip_tbs":false,"can_bws_limit_bawu_log":false,"can_cancel_filter_id":false,"can_cancel_mask_delete":false,"can_cancel_mask_good":false,"can_cancel_mask_top":false,"can_del_manager_team":false,"can_edit_bakan":false,"can_edit_daquan":false,"can_edit_gconforum":false,"can_filter_id":false,"can_filter_ip":false,"can_mask_delete":false,"can_mask_good":false,"can_mask_top":false,"can_member_top":false,"can_op_FDS":false,"can_op_as_4thmgr":false,"can_op_as_broadcast_admin":false,"can_op_as_category_editor":false,"can_op_as_editor":false,"can_op_as_entertainment_manager":false,"can_op_as_operator":false,"can_op_as_profession_manager":false,"can_op_as_vertical_operator":false,"can_op_common_bawu":false,"can_op_disk":false,"can_op_frsbg":false,"can_op_good_class":false,"can_op_pic":false,"can_op_topic":false,"can_op_video":false,"can_op_wise_group":false,"can_paper_ignore_vcode":false,"can_pass_media_limit":false,"can_post":true,"can_post_frs":true,"can_post_pb":true,"can_send_memo":false,"can_super":false,"can_tobe_assist":false,"can_tobe_editor":false,"can_tobe_manager":false,"can_tobe_pri_content_assist":false,"can_tobe_pri_manage_assist":false,"can_toms_operator_alt_basic":false,"can_toms_operator_basic":false,"can_type1_audit_post":false,"can_type2_audit_post":false,"can_type3_audit_post":false,"can_type4_audit_post":false,"can_type5_audit_post":false,"can_unknown":false,"can_view_freq":false,"can_vip_jubao":false,"can_vote":false,"forever_ban":0,"lz_del":false,"picasso":false,"share_forum_perm":[],"can_set_topic":false,"reply_private_flag":1},        is_thread_admin:0,        is_posts_admin:0,        staticDomain: "https://gsp0.baidu.com/5aAHeD3nKhI2p27j8IqW0jdnxx1xbK/"    };    for (var item in commonPageData) {        PageData[item] = commonPageData[item];    }    PageData.forum = {        id: "308057",        forum_id: "308057",        name: '安科', forum_name: '安科', name_url: "%E5%AE%89%E7%A7%91&ie=utf-8",        name_encode: "%E5%AE%89%E7%A7%91&ie=utf-8",        member_name_url: "%E7%A7%91%E7%B2%89&ie=utf-8",        first_class: "文学",        second_class: "文学话题",        album_good_smallflow: "",        avatar: "http:\/\/tiebapic.baidu.com\/forum\/wh=120,120\/sign=e285b50f2e12b31bc739c528b4281a4b\/9e3df8dcd100baa15c196ef35010b912c8fc2e44.jpg",        forbid_flag: "1",        has_picture_frs: "1",        member_count: "10419",        member_name: "科粉",        post_num: "430256",        shield_post: "1",        sign_in_info: {"user_info":{"user_id":1172997347,"is_sign_in":0,"user_sign_rank":0,"sign_time":0,"cont_sign_num":0,"cout_total_sing_num":0,"total_resign_num":0,"hun_sign_num":0,"is_org_disabled":0,"c_sign_num":0,"cm_sign_num":0},"forum_info":{"is_on":true,"is_filter":false,"forum_info":{"forum_id":308057,"level_1_dir_name":"\u6587\u5b66\u8bdd\u9898"},"current_rank_info":{"sign_count":282,"member_count":10412,"sign_rank":223,"dir_rate":"0.1"},"level_1_dir_name":"\u6587\u5b66","level_2_dir_name":"\u6587\u5b66\u8bdd\u9898","yesterday_rank_info":{"sign_count":675,"member_count":10388,"sign_rank":230,"dir_rate":"0.1"},"weekly_rank_info":{"sign_count":678,"member_count":10138,"sign_rank":247},"monthly_rank_info":{"sign_count":0,"member_count":0,"sign_rank":0}}}};    var commonPageDataUser = {        bg_id: "1130182",        cur_score: "0",        email: "li****@msn.com",        feedNumNew: "",        free_flag: "",        is_black: 0,        is_block: 0,        is_half_user: 0,        is_like: 0,        is_tenyear: 0,        itieba_id: "",        level_id: "1",        level_name: "原点",        meizhi_level: 0,        mobile: "",        mobilephone: "178******72",        name_link: "&ie=utf-8",        name_show: "",        name_weak: "",        open_uid: "",        score_card: "",        score_left: "5",        sid: "",        source_id: "",        start_time: "",        superboy: "",        use_sig: 0,        user_sex: 0,        user_status: 1,        user_type: 0,        userhide: 0,        picasso: "",        global: {"tbmall_newprops":0},        rank: null,        tbguess_card: null,        tips: [],        urank: []};    for (var key in commonPageDataUser) {        PageData['user'][key] = commonPageDataUser[key];    }    PageData.user.forbidden = PageData.user.is_login ? [] : {};    PageData.thread = {        author: "地底的月亮",        thread_id:7278674944,        title: "回复：【安科漫画】魔物训使", reply_num:1824, thread_type: "0",        topic: {            is_topic: false,            topic_type: false,            is_live_post: false,            is_lpost: false,            lpost_type: 0        }, /*null,*/        is_ad:0, video_url: "" };    PageData.post_perm = {"img_num":10,"video_num":10,"smiley_num":100,"white_list":["http:\/\/www.tudou.com\/","http:\/\/v.blog.sohu.com\/","http:\/\/tv.sohu.com\/","http:\/\/share.vrs.sohu.com\/","http:\/\/my.tv.sohu.com\/","http:\/\/player.56.com\/","http:\/\/www.56.com\/","http:\/\/kankanews.com\/","http:\/\/video6.smgbb.cn\/","http:\/\/www.youku.com\/","http:\/\/player.youku.com\/","http:\/\/static.youku.com\/","http:\/\/www.ku6.com\/","http:\/\/player.ku6.com\/","http:\/\/video.sina.com.cn\/","http:\/\/vhead.blog.sina.com.cn\/","http:\/\/you.video.sina.com.cn\/","http:\/\/video.qq.com\/","http:\/\/www.baidu.com\/","http:\/\/box.baidu.com\/","http:\/\/hi.baidu.com\/","http:\/\/mv.baidu.com\/","http:\/\/mvimg.baidu.com\/","http:\/\/mvideo.baidu.com\/","http:\/\/player.cntv.cn\/","http:\/\/player.xiyou.cntv.cn\/","http:\/\/www.yinyuetai.com\/","http:\/\/player.yinyuetai.com\/","http:\/\/www.aipai.com\/","http:\/\/www.cutv.com\/","http:\/\/player.cutv.com\/","http:\/\/www.pptv.com\/","http:\/\/v.pptv.com\/","http:\/\/www.letv.com\/","http:\/\/www.iqiyi.com\/","http:\/\/yule.iqiyi.com\/","http:\/\/player.video.qiyi.com\/","http:\/\/www.ifeng.com\/","http:\/\/s.v.ifeng.com\/","http:\/\/v.ifeng.com\/","http:\/\/www.m1905.com\/","http:\/\/www.joy.cn\/","http:\/\/client.joy.cn\/","http:\/\/www.molihe.com\/","http:\/\/mv.molihe.com\/","http:\/\/swf.molihe.com\/","http:\/\/www.baomihua.com\/","http:\/\/video.baomihua.com\/","http:\/\/www.ouou.com\/","http:\/\/flash.ouou.com\/","http:\/\/dv.ouou.com\/","http:\/\/misc.home.news.cn\/","http:\/\/www.news.cn\/","http:\/\/www.wasu.cn\/","http:\/\/play1.wasu.cn\/","http:\/\/play.wasu.cn\/","http:\/\/v.iask.com\/","http:\/\/i7.imgs.letv.com\/","http:\/\/static.video.qq.com\/","http:\/\/player.pptv.com\/","http:\/\/www.mgtv.com\/","http:\/\/www.meipai.com\/","http:\/\/baishi.baidu.com\/","http:\/\/www.bilibili.com\/","http:\/\/share.acg.tv\/","http:\/\/static.hdslb.com\/","http:\/\/bangumi.bilibili.com"]};    PageData.special = {"has_sub_post":1,"has_grade":1,"has_lucky_lottery":0,"has_basket_lottery":0,"has_ssq_lottery":0,"has_foot_lottery":1,"is_match_news":0,"lz_only":0,"has_lz_only":1,"is_from_spider":false};    PageData.isPicBa = "1";    PageData.pager = {"cur_page":1,"total_page":70,"page_size":30};        var g_pg = {        imageLimite: 10,        flashWhiteList:["http:\/\/www.tudou.com\/","http:\/\/v.blog.sohu.com\/","http:\/\/tv.sohu.com\/","http:\/\/share.vrs.sohu.com\/","http:\/\/my.tv.sohu.com\/","http:\/\/player.56.com\/","http:\/\/www.56.com\/","http:\/\/kankanews.com\/","http:\/\/video6.smgbb.cn\/","http:\/\/www.youku.com\/","http:\/\/player.youku.com\/","http:\/\/static.youku.com\/","http:\/\/www.ku6.com\/","http:\/\/player.ku6.com\/","http:\/\/video.sina.com.cn\/","http:\/\/vhead.blog.sina.com.cn\/","http:\/\/you.video.sina.com.cn\/","http:\/\/video.qq.com\/","http:\/\/www.baidu.com\/","http:\/\/box.baidu.com\/","http:\/\/hi.baidu.com\/","http:\/\/mv.baidu.com\/","http:\/\/mvimg.baidu.com\/","http:\/\/mvideo.baidu.com\/","http:\/\/player.cntv.cn\/","http:\/\/player.xiyou.cntv.cn\/","http:\/\/www.yinyuetai.com\/","http:\/\/player.yinyuetai.com\/","http:\/\/www.aipai.com\/","http:\/\/www.cutv.com\/","http:\/\/player.cutv.com\/","http:\/\/www.pptv.com\/","http:\/\/v.pptv.com\/","http:\/\/www.letv.com\/","http:\/\/www.iqiyi.com\/","http:\/\/yule.iqiyi.com\/","http:\/\/player.video.qiyi.com\/","http:\/\/www.ifeng.com\/","http:\/\/s.v.ifeng.com\/","http:\/\/v.ifeng.com\/","http:\/\/www.m1905.com\/","http:\/\/www.joy.cn\/","http:\/\/client.joy.cn\/","http:\/\/www.molihe.com\/","http:\/\/mv.molihe.com\/","http:\/\/swf.molihe.com\/","http:\/\/www.baomihua.com\/","http:\/\/video.baomihua.com\/","http:\/\/www.ouou.com\/","http:\/\/flash.ouou.com\/","http:\/\/dv.ouou.com\/","http:\/\/misc.home.news.cn\/","http:\/\/www.news.cn\/","http:\/\/www.wasu.cn\/","http:\/\/play1.wasu.cn\/","http:\/\/play.wasu.cn\/","http:\/\/v.iask.com\/","http:\/\/i7.imgs.letv.com\/","http:\/\/static.video.qq.com\/","http:\/\/player.pptv.com\/","http:\/\/www.mgtv.com\/","http:\/\/www.meipai.com\/","http:\/\/baishi.baidu.com\/","http:\/\/www.bilibili.com\/","http:\/\/share.acg.tv\/","http:\/\/static.hdslb.com\/","http:\/\/bangumi.bilibili.com"],        flashLimite: 10,        smileyLimite:100};`
	info, err := tiebaExtractor(text)
	ast.Equal(nil, err)
	ast.Equal(postInformation{
		Title:     "【安科漫画】魔物训使",
		TotalPage: 35,
	}, info)
}

func TestTiebaProc(t *testing.T) {
	logger = utils.GetLogger().Sugar()
	ast := assert.New(t)
	ctx := context.Background()
	his := History{
		Url: "https://tieba.baidu.com/p/7278674944?pn=2",
	}
	err := tiebaProc(ctx, &his)
	ast.Equal(nil, err)
	if ast.Equal(his.Title, "【安科漫画】魔物训使") && ast.Equal(35, his.TotalPage) {
		t.Log(his)
	}

}
